@page "/add-good-work"
@using System.ComponentModel.DataAnnotations
@using CharityRabbit.Data
@using CharityRabbit.Models
@using MLS.Api.Services
@using GoogleMapsComponents
@using GoogleMapsComponents.Maps
@using MudBlazor
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization

@inject Neo4jService _neo4jService
@inject GooglePlacesService _googlePlacesService
@inject GeocodingService _geoCodingServices
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Add Good Work - Charity Rabbit</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4 mt-4">
    <MudText Typo="Typo.h3" GutterBottom="true">Create New Good Work</MudText>

    <EditForm Model="@goodWork" OnValidSubmit="OnValidSubmit" FormName="AddGoodWorkForm">
        <DataAnnotationsValidator />
        <MudGrid>
            <!-- Form Section -->
            <MudItem xs="12" sm="6">
                <MudCard>
                    <MudCardContent>
                        <MudTextField Label="Name" HelperText="Enter the project name"
                                      @bind-Value="goodWork.Name" For="@(() => goodWork.Name)" />

                        <MudAutocomplete T="string"
                                         Label="Category"
                                         @bind-Value="goodWork.Category"
                                         SearchFunc="SearchCategories"
                                         Clearable="true"
                                         Dense="false"
                                         Variant="Variant.Outlined"
                                         HelperText="Choose a category or enter your own"
                                         Class="mt-3"
                                         CoerceText="true"
                                         CoerceValue="true" />

                        <MudTextField Label="Description" HelperText="Describe the good work" Lines="3"
                                      @bind-Value="goodWork.Description" For="@(() => goodWork.Description)" Class="mt-3" />

                        <MudTextField Label="Detailed Description" HelperText="Provide more details" Lines="5"
                                      @bind-Value="goodWork.DetailedDescription" Class="mt-3" />

                        <MudAutocomplete T="string"
                                         Label="Address"
                                         Value="@goodWork.Address"
                                         SearchFunc="SearchAddresses"
                                         Clearable="true"
                                         Dense="true"
                                         Variant="Variant.Outlined"
                                         ValueChanged="OnAddressChanged"
                                         Placeholder="Enter an address..."
                                         Class="mt-3" />

                        <MudDatePicker Label="Start Date"
                                       Editable="true"
                                       @bind-Date="goodWork.StartTime"
                                       Class="mt-3" />

                        <MudTimePicker Label="Start Time" InputIcon="Icons.Material.Filled.AccessTime"
                                       AmPm="true" @bind-Time="_startTime" Class="mt-3" />

                        <MudDatePicker Label="End Date"
                                       Editable="true"
                                       @bind-Date="goodWork.EndTime"
                                       Class="mt-3" />

                        <MudTimePicker Label="End Time"
                                       InputIcon="Icons.Material.Filled.AccessTime"
                                       AmPm="true" @bind-Time="_endTime" Class="mt-3" />

                        <MudTextField Label="Contact Name" @bind-Value="goodWork.ContactName"
                                      For="@(() => goodWork.ContactName)" Class="mt-3" />
                        <MudTextField Label="Contact Email" @bind-Value="goodWork.ContactEmail"
                                      For="@(() => goodWork.ContactEmail)" Class="mt-3" />
                        <MudTextField Label="Contact Phone" @bind-Value="goodWork.ContactPhone"
                                      For="@(() => goodWork.ContactPhone)" Class="mt-3" />

                        <MudSelect Label="Effort Level" @bind-Value="goodWork.EffortLevel" Class="mt-3">
                            <MudSelectItem Value=@("Light")>Light</MudSelectItem>
                            <MudSelectItem Value=@("Moderate")>Moderate</MudSelectItem>
                            <MudSelectItem Value=@("Heavy")>Heavy</MudSelectItem>
                        </MudSelect>

                        <MudNumericField Label="Max Participants" @bind-Value="goodWork.MaxParticipants" 
                                       Class="mt-3" Min="0" HideSpinButtons="true" />

                        <MudNumericField Label="Minimum Age" @bind-Value="goodWork.MinimumAge" 
                                       Class="mt-3" Min="0" HideSpinButtons="true" />

                        <MudSwitch @bind-Value="goodWork.IsVirtual" Label="Virtual Event" Color="Color.Primary" Class="mt-3" />
                        <MudSwitch @bind-Value="goodWork.FamilyFriendly" Label="Family Friendly" Color="Color.Primary" />
                        <MudSwitch @bind-Value="goodWork.IsAccessible" Label="Wheelchair Accessible" Color="Color.Primary" />

                        <!-- Recurring Event Options -->
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Recurring Event Options</MudText>
                        
                        <MudSwitch @bind-Value="goodWork.IsRecurring" Label="This is a recurring event" Color="Color.Primary" />
                        
                        @if (goodWork.IsRecurring)
                        {
                            <MudSelect Label="Recurrence Pattern" @bind-Value="selectedRecurrenceType" Class="mt-3">
                                <MudSelectItem Value="@("DAILY")">Daily</MudSelectItem>
                                <MudSelectItem Value="@("WEEKLY")">Weekly</MudSelectItem>
                                <MudSelectItem Value="@("MONTHLY")">Monthly</MudSelectItem>
                                <MudSelectItem Value="@("YEARLY")">Yearly</MudSelectItem>
                            </MudSelect>

                            <MudNumericField Label="Repeat Every" @bind-Value="recurrenceInterval" 
                                           Class="mt-3" Min="1" HideSpinButtons="false" 
                                           HelperText="@GetIntervalHelperText()" />

                            @if (selectedRecurrenceType == "WEEKLY")
                            {
                                <MudText Typo="Typo.subtitle2" Class="mt-3">Select Days:</MudText>
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Monday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Monday))">Monday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Tuesday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Tuesday))">Tuesday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Wednesday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Wednesday))">Wednesday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Thursday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Thursday))">Thursday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Friday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Friday))">Friday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Saturday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Saturday))">Saturday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Sunday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Sunday))">Sunday</MudChip>
                                </div>
                            }

                            <MudDatePicker Label="Recurrence End Date" 
                                         @bind-Date="goodWork.RecurrenceEndDate"
                                         MinDate="@DateTime.Today"
                                         Class="mt-3" 
                                         HelperText="Leave empty to repeat indefinitely" />
                        }

                        @if (success)
                        {
                            <MudText Color="Color.Success" Class="mt-3">Good work successfully added!</MudText>
                        }
                        else if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <MudAlert Severity="Severity.Error" Class="mt-3">@errorMessage</MudAlert>
                        }
                        else
                        {
                            <MudText Color="@Color.Error">
                                <ValidationSummary />
                            </MudText>
                        }
                    </MudCardContent>

                    <MudCardActions>
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">
                            Create Good Work
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <!-- Map Section -->
            <MudItem xs="12" sm="6">
                <MudPaper Elevation="4" Class="pa-4">
                    <MudText Typo="Typo.h5" Class="mb-2">Location Map</MudText>
                    <GoogleMap @ref="_map" Options="@_mapOptions" Height="600px" OnAfterInit="InitializeMap">
                    </GoogleMap>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </EditForm>
</MudContainer>

@code {
    private GoodWorksModel goodWork = new GoodWorksModel();
    private bool success;
    private string? errorMessage;
    private string? userId;
    private GoogleMap? _map;
    private MapOptions _mapOptions = new();
    private Marker? _marker;

    private TimeSpan? _startTime = new TimeSpan(9, 0, 0);
    private TimeSpan? _endTime = new TimeSpan(17, 0, 0);

    // Recurring event fields
    private string selectedRecurrenceType = "WEEKLY";
    private int recurrenceInterval = 1;
    private List<DayOfWeek> selectedDays = new();

    private readonly List<string> _predefinedCategories = new()
    {
        "Food Bank",
        "Homeless Shelter",
        "Environmental",
        "Education",
        "Healthcare",
        "Animal Welfare",
        "Community Service",
        "Youth Programs",
        "Senior Care",
        "Disaster Relief"
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        }

        _mapOptions = new MapOptions
        {
            Zoom = 12,
            Center = new LatLngLiteral(34.7304, -86.5861),
            MapTypeId = MapTypeId.Roadmap
        };

        goodWork.CreatedDate = DateTime.UtcNow;
    }

    private string GetIntervalHelperText()
    {
        return selectedRecurrenceType switch
        {
            "DAILY" => $"Repeats every {recurrenceInterval} day{(recurrenceInterval > 1 ? "s" : "")}",
            "WEEKLY" => $"Repeats every {recurrenceInterval} week{(recurrenceInterval > 1 ? "s" : "")}",
            "MONTHLY" => $"Repeats every {recurrenceInterval} month{(recurrenceInterval > 1 ? "s" : "")}",
            "YEARLY" => $"Repeats every {recurrenceInterval} year{(recurrenceInterval > 1 ? "s" : "")}",
            _ => ""
        };
    }

    private void ToggleDay(DayOfWeek day)
    {
        if (selectedDays.Contains(day))
        {
            selectedDays.Remove(day);
        }
        else
        {
            selectedDays.Add(day);
        }
    }

    private void BuildRecurrencePattern()
    {
        if (!goodWork.IsRecurring)
        {
            goodWork.RecurrencePattern = null;
            return;
        }

        var pattern = $"{selectedRecurrenceType}:{recurrenceInterval}";

        if (selectedRecurrenceType == "WEEKLY" && selectedDays.Any())
        {
            var days = string.Join(",", selectedDays.Select(d => d.ToString().Substring(0, 3).ToUpper()));
            pattern += $":{days}";
        }
        else if (selectedRecurrenceType == "MONTHLY" && goodWork.StartTime.HasValue)
        {
            pattern += $":{goodWork.StartTime.Value.Day}";
        }
        else if (selectedRecurrenceType == "YEARLY" && goodWork.StartTime.HasValue)
        {
            pattern += $":{goodWork.StartTime.Value.Month}:{goodWork.StartTime.Value.Day}";
        }

        goodWork.RecurrencePattern = pattern;
    }

    private async Task<IEnumerable<string>> SearchAddresses(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value)) return Array.Empty<string>();
        return await _googlePlacesService.GetAddressSuggestionsAsync(value);
    }

    private Task<IEnumerable<string>> SearchCategories(string value, CancellationToken cancellationToken)
    {
        // If no search value, return all predefined categories
        if (string.IsNullOrWhiteSpace(value))
        {
            return Task.FromResult<IEnumerable<string>>(_predefinedCategories);
        }

        // Filter categories based on search value
        var filtered = _predefinedCategories
            .Where(c => c.Contains(value, StringComparison.OrdinalIgnoreCase))
            .ToList();

        // If user is typing something not in the list, add it as an option
        if (!filtered.Any() || !filtered.Any(c => c.Equals(value, StringComparison.OrdinalIgnoreCase)))
        {
            filtered.Insert(0, value);
        }

        return Task.FromResult<IEnumerable<string>>(filtered);
    }

    private async Task OnAddressChanged(string address)
    {
        if (string.IsNullOrEmpty(address)) return;

        var (latitude, longitude) = await _geoCodingServices.GetCoordinatesAsync(address);

        goodWork.Address = address;
        goodWork.Latitude = latitude;
        goodWork.Longitude = longitude;

        await UpdateMapLocation(latitude, longitude);
    }

    private async Task InitializeMap()
    {
        if (goodWork.Latitude != 0 && goodWork.Longitude != 0)
        {
            await UpdateMapLocation(goodWork.Latitude, goodWork.Longitude);
        }
    }

    private async Task UpdateMapLocation(double latitude, double longitude)
    {
        if (_map == null) return;

        var position = new LatLngLiteral(latitude, longitude);

        await _map.InteropObject.SetCenter(position);

        if (_marker != null)
        {
            await _marker.SetMap(null);
        }

        _marker = await Marker.CreateAsync(_map.JsRuntime, new MarkerOptions
        {
            Position = position,
            Map = _map.InteropObject,
            Title = "Selected Location"
        });
    }

    private async Task OnValidSubmit()
    {
        try
        {
            if (goodWork.StartTime.HasValue && _startTime.HasValue)
            {
                goodWork.StartTime = goodWork.StartTime.Value.Date.Add(_startTime.Value);
            }
            else if (_startTime.HasValue)
            {
                goodWork.StartTime = DateTime.Today.Add(_startTime.Value);
            }

            if (goodWork.EndTime.HasValue && _endTime.HasValue)
            {
                goodWork.EndTime = goodWork.EndTime.Value.Date.Add(_endTime.Value);
            }
            else if (_endTime.HasValue)
            {
                goodWork.EndTime = DateTime.Today.Add(_endTime.Value);
            }

            // Build recurrence pattern before saving
            BuildRecurrencePattern();

            await _neo4jService.CreateGoodWorkAsync(goodWork, userId);
            success = true;
            errorMessage = null;

            // Reset form after a short delay
            await Task.Delay(1500);
            goodWork = new GoodWorksModel { CreatedDate = DateTime.UtcNow };
            selectedDays.Clear();
            success = false;

            if (_marker != null)
            {
                await _marker.SetMap(null);
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating good work: {ex.Message}";
            success = false;
        }
    }
}
