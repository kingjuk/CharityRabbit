@page "/add-good-work"
@using System.ComponentModel.DataAnnotations
@using CharityRabbit.Data
@using CharityRabbit.Models
@using MLS.Api.Services
@using GoogleMapsComponents
@using GoogleMapsComponents.Maps
@using MudBlazor
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@using Neo4j.Driver

@inject Neo4jService _neo4jService
@inject OrganizationService _organizationService
@inject GooglePlacesService _googlePlacesService
@inject GeocodingService _geoCodingServices
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SkillService _skillService
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<PageTitle>Add Good Work - Charity Rabbit</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4 mt-4">
    <MudText Typo="Typo.h3" GutterBottom="true">Create New Good Work</MudText>

    <EditForm Model="@goodWork" OnValidSubmit="OnValidSubmit">
        <DataAnnotationsValidator />
        <MudGrid>
            <!-- Form Section -->
            <MudItem xs="12" sm="6">
                <MudCard>
                    <MudCardContent>
                        <!-- Organization Selector -->
                        @if (userOrganizations?.Any() == true)
                        {
                            <MudAlert Severity="MudBlazor.Severity.Info" Dense="true" Class="mb-3">
                                You can post this event as yourself or as an organization you're part of.
                            </MudAlert>
                            
                            <MudSelect Label="Post As" @bind-Value="selectedOrganizationId" Class="mb-3" Variant="Variant.Outlined">
                                <MudSelectItem Value="@((long?)null)">
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="MudBlazor.Size.Small" />
                                        Post as Individual
                                    </div>
                                </MudSelectItem>
                                @foreach (var org in userOrganizations.Where(o => o.IsUserAdmin))
                                {
                                    <MudSelectItem Value="@org.Id">
                                        <div class="d-flex align-center gap-2">
                                            <MudIcon Icon="@Icons.Material.Filled.Business" Size="MudBlazor.Size.Small" Color="Color.Primary" />
                                            @org.Name
                                            <MudChip T="string" Size="MudBlazor.Size.Small" Color="Color.Error">Admin</MudChip>
                                        </div>
                                    </MudSelectItem>
                                }
                            </MudSelect>
                            
                            @if (selectedOrganizationId.HasValue)
                            {
                                <MudAlert Severity="MudBlazor.Severity.Success" Dense="true" Class="mb-3">
                                    <strong>Posting as:</strong> @userOrganizations.FirstOrDefault(o => o.Id == selectedOrganizationId)?.Name
                                </MudAlert>
                            }
                        }

                        <MudTextField Label="Name" HelperText="Enter the project name"
                                      @bind-Value="goodWork.Name" For="@(() => goodWork.Name)" />

                        <MudAutocomplete T="string"
                                         Label="Category"
                                         @bind-Value="goodWork.Category"
                                         SearchFunc="SearchCategories"
                                         Clearable="true"
                                         Dense="false"
                                         Variant="Variant.Outlined"
                                         HelperText="Choose a category or enter your own"
                                         Class="mt-3"
                                         CoerceText="true"
                                         CoerceValue="true" />

                        <MudTextField Label="Description" HelperText="Describe the good work" Lines="3"
                                      @bind-Value="goodWork.Description" For="@(() => goodWork.Description)" Class="mt-3" />

                        <MudTextField Label="Detailed Description" HelperText="Provide more details" Lines="5"
                                      @bind-Value="goodWork.DetailedDescription" Class="mt-3" />

                        <MudAutocomplete T="string"
                                         Label="Address"
                                         Value="@goodWork.Address"
                                         SearchFunc="SearchAddresses"
                                         Clearable="true"
                                         Dense="true"
                                         Variant="Variant.Outlined"
                                         ValueChanged="OnAddressChanged"
                                         Placeholder="Enter an address..."
                                         Class="mt-3" />

                        <MudDatePicker Label="Start Date"
                                       Editable="true"
                                       @bind-Date="goodWork.StartTime"
                                       Class="mt-3" />

                        <MudTimePicker Label="Start Time" InputIcon="Icons.Material.Filled.AccessTime"
                                       AmPm="true" @bind-Time="_startTime" Class="mt-3" />

                        <MudDatePicker Label="End Date"
                                       Editable="true"
                                       @bind-Date="goodWork.EndTime"
                                       Class="mt-3" />

                        <MudTimePicker Label="End Time"
                                       InputIcon="Icons.Material.Filled.AccessTime"
                                       AmPm="true" @bind-Time="_endTime" Class="mt-3" />

                        <MudTextField Label="Contact Name" @bind-Value="goodWork.ContactName"
                                      For="@(() => goodWork.ContactName)" Class="mt-3" />
                        <MudTextField Label="Contact Email" @bind-Value="goodWork.ContactEmail"
                                      For="@(() => goodWork.ContactEmail)" Class="mt-3" />
                        <MudTextField Label="Contact Phone" @bind-Value="goodWork.ContactPhone"
                                      For="@(() => goodWork.ContactPhone)" Class="mt-3" />

                        <!-- Skills Selector -->
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Required Skills</MudText>
                        <MudAlert Severity="MudBlazor.Severity.Info" Dense="true" Class="mb-2">
                            Select skills volunteers should have. Leave empty for "No Skills Required"
                        </MudAlert>

                        <MudAutocomplete T="string"
                                         Label="Add Skill"
                                         SearchFunc="SearchSkills"
                                         @bind-Value="selectedSkill"
                                         Clearable="true"
                                         Dense="false"
                                         Variant="Variant.Outlined"
                                         HelperText="Type to search or add new skills"
                                         Class="mb-3"
                                         CoerceText="true"
                                         CoerceValue="false"
                                         ResetValueOnEmptyText="true"
                                         @onblur="OnSkillBlur" />

                        <div class="d-flex flex-wrap gap-2 mb-3">
                            @foreach (var skill in goodWork.RequiredSkills)
                            {
                                <MudChip T="string" 
                                       Text="@skill" 
                                       Color="Color.Primary"
                                       OnClose="@(() => RemoveSkill(skill))">
                                    @skill
                                </MudChip>
                            }
                            @if (!goodWork.RequiredSkills.Any())
                            {
                                <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.Check">No Skills Required</MudChip>
                            }
                        </div>

                        <MudNumericField Label="Max Participants" @bind-Value="goodWork.MaxParticipants" 
                                       Class="mt-3" Min="0" HideSpinButtons="true" />

                        <MudNumericField Label="Minimum Age" @bind-Value="goodWork.MinimumAge" 
                                       Class="mt-3" Min="0" HideSpinButtons="true" />

                        <MudSwitch @bind-Value="goodWork.IsVirtual" Label="Virtual Event" Color="Color.Primary" Class="mt-3" />
                        <MudSwitch @bind-Value="goodWork.FamilyFriendly" Label="Family Friendly" Color="Color.Primary" />
                        <MudSwitch @bind-Value="goodWork.IsAccessible" Label="Wheelchair Accessible" Color="Color.Primary" />

                        <!-- Recurring Event Options -->
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Recurring Event Options</MudText>
                        
                        <MudSwitch @bind-Value="goodWork.IsRecurring" Label="This is a recurring event" Color="Color.Primary" />
                        
                        @if (goodWork.IsRecurring)
                        {
                            <MudSelect Label="Recurrence Pattern" @bind-Value="selectedRecurrenceType" Class="mt-3">
                                <MudSelectItem Value="@("DAILY")">Daily</MudSelectItem>
                                <MudSelectItem Value="@("WEEKLY")">Weekly</MudSelectItem>
                                <MudSelectItem Value="@("MONTHLY")">Monthly</MudSelectItem>
                                <MudSelectItem Value="@("YEARLY")">Yearly</MudSelectItem>
                            </MudSelect>

                            <MudNumericField Label="Repeat Every" @bind-Value="recurrenceInterval" 
                                           Class="mt-3" Min="1" HideSpinButtons="false" 
                                           HelperText="@GetIntervalHelperText()" />

                            @if (selectedRecurrenceType == "WEEKLY")
                            {
                                <MudText Typo="Typo.subtitle2" Class="mt-3">Select Days:</MudText>
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Monday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Monday))">Monday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Tuesday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Tuesday))">Tuesday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Wednesday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Wednesday))">Wednesday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Thursday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Thursday))">Thursday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Friday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Friday))">Friday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Saturday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Saturday))">Saturday</MudChip>
                                    <MudChip T="string" Color="@(selectedDays.Contains(DayOfWeek.Sunday) ? Color.Primary : Color.Default)" 
                                           OnClick="@(() => ToggleDay(DayOfWeek.Sunday))">Sunday</MudChip>
                                </div>
                            }

                            <MudDatePicker Label="Recurrence End Date" 
                                         @bind-Date="goodWork.RecurrenceEndDate"
                                         MinDate="@DateTime.Today"
                                         Class="mt-3" 
                                         HelperText="Leave empty to repeat indefinitely" />
                        }

                        @if (success)
                        {
                            <MudText Color="Color.Success" Class="mt-3">Good work successfully added!</MudText>
                        }
                        else if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <MudAlert Severity="MudBlazor.Severity.Error" Class="mt-3">@errorMessage</MudAlert>
                        }
                        else
                        {
                            <MudText Color="@Color.Error">
                                <ValidationSummary />
                            </MudText>
                        }
                    </MudCardContent>

                    <MudCardActions>
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">
                            Create Good Work
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <!-- Map Section -->
            <MudItem xs="12" sm="6">
                <MudPaper Elevation="4" Class="pa-4">
                    <MudText Typo="Typo.h5" Class="mb-2">Location Map</MudText>
                    @if (mapError)
                    {
                        <MudAlert Severity="MudBlazor.Severity.Warning" Class="mb-2">
                            Map failed to load. You can still create the event - the location will be saved based on the address you entered.
                        </MudAlert>
                    }
                    <div style="height: 600px; width: 100%;">
                        <GoogleMap @ref="_map" 
                                   Id="addGoodWorkMap" 
                                   Options="@_mapOptions" 
                                   Height="100%" 
                                   OnAfterInit="InitializeMap">
                        </GoogleMap>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </EditForm>
</MudContainer>

@code {
    private GoodWorksModel goodWork = new GoodWorksModel();
    private bool success;
    private string? errorMessage;
    private bool mapError = false;
    private string? userId;
    private string? selectedSkill;
    private GoogleMap? _map;
    private MapOptions _mapOptions = new();
    private Marker? _marker;

    private TimeSpan? _startTime = new TimeSpan(9, 0, 0);
    private TimeSpan? _endTime = new TimeSpan(17, 0, 0);

    // Recurring event fields
    private string selectedRecurrenceType = "WEEKLY";
    private int recurrenceInterval = 1;
    private List<DayOfWeek> selectedDays = new();
    
    // Organization fields
    private List<OrganizationModel>? userOrganizations;
    private long? selectedOrganizationId;

    private readonly List<string> _predefinedCategories = new()
    {
        "Food Bank",
        "Homeless Shelter",
        "Environmental",
        "Education",
        "Healthcare",
        "Animal Welfare",
        "Community Service",
        "Youth Programs",
        "Senior Care",
        "Disaster Relief"
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            
            // Load user's organizations (where they are admin)
            if (!string.IsNullOrEmpty(userId))
            {
                userOrganizations = await _organizationService.GetUserOrganizationsAsync(userId);
            }
        }

        // Try to get user's location, fall back to Huntsville, AL
        var userLocation = await TryGetUserLocation();

        _mapOptions = new MapOptions
        {
            Zoom = 12,
            Center = userLocation,
            MapTypeId = MapTypeId.Roadmap
        };

        goodWork.CreatedDate = DateTime.UtcNow;
    }

    private async Task<LatLngLiteral> TryGetUserLocation()
    {
        // Default location (Huntsville, AL)
        var defaultLocation = new LatLngLiteral(34.7304, -86.5861);
        
        try
        {
            // Try to get user's current location from browser
            var result = await JSRuntime.InvokeAsync<GeolocationResult?>("geolocationHelper.getCurrentPosition");
            
            if (result != null && result.Latitude != 0 && result.Longitude != 0)
            {
                Console.WriteLine($"User location detected: {result.Latitude}, {result.Longitude}");
                return new LatLngLiteral(result.Latitude, result.Longitude);
            }
            
            Console.WriteLine("Using default location (Huntsville, AL)");
            return defaultLocation;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Geolocation error: {ex.Message}. Using default location.");
            return defaultLocation;
        }
    }

    // Helper class for geolocation result
    private class GeolocationResult
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public double Accuracy { get; set; }
    }

    private string GetIntervalHelperText()
    {
        return selectedRecurrenceType switch
        {
            "DAILY" => $"Repeats every {recurrenceInterval} day{(recurrenceInterval > 1 ? "s" : "")}",
            "WEEKLY" => $"Repeats every {recurrenceInterval} week{(recurrenceInterval > 1 ? "s" : "")}",
            "MONTHLY" => $"Repeats every {recurrenceInterval} month{(recurrenceInterval > 1 ? "s" : "")}",
            "YEARLY" => $"Repeats every {recurrenceInterval} year{(recurrenceInterval > 1 ? "s" : "")}",
            _ => ""
        };
    }

    private void ToggleDay(DayOfWeek day)
    {
        if (selectedDays.Contains(day))
        {
            selectedDays.Remove(day);
        }
        else
        {
            selectedDays.Add(day);
        }
    }

    private void BuildRecurrencePattern()
    {
        if (!goodWork.IsRecurring)
        {
            goodWork.RecurrencePattern = null;
            return;
        }

        var pattern = $"{selectedRecurrenceType}:{recurrenceInterval}";

        if (selectedRecurrenceType == "WEEKLY" && selectedDays.Any())
        {
            var days = string.Join(",", selectedDays.Select(d => d.ToString().Substring(0, 3).ToUpper()));
            pattern += $":{days}";
        }
        else if (selectedRecurrenceType == "MONTHLY" && goodWork.StartTime.HasValue)
        {
            pattern += $":{goodWork.StartTime.Value.Day}";
        }
        else if (selectedRecurrenceType == "YEARLY" && goodWork.StartTime.HasValue)
        {
            pattern += $":{goodWork.StartTime.Value.Month}:{goodWork.StartTime.Value.Day}";
        }

        goodWork.RecurrencePattern = pattern;
    }

    private async Task<IEnumerable<string>> SearchAddresses(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value)) return Array.Empty<string>();
        return await _googlePlacesService.GetAddressSuggestionsAsync(value);
    }

    private Task<IEnumerable<string>> SearchCategories(string value, CancellationToken cancellationToken)
    {
        // If no search value, return all predefined categories
        if (string.IsNullOrWhiteSpace(value))
        {
            return Task.FromResult<IEnumerable<string>>(_predefinedCategories);
        }

        // Filter categories based on search value
        var filtered = _predefinedCategories
            .Where(c => c.Contains(value, StringComparison.OrdinalIgnoreCase))
            .ToList();

        // If user is typing something not in the list, add it as an option
        if (!filtered.Any() || !filtered.Any(c => c.Equals(value, StringComparison.OrdinalIgnoreCase)))
        {
            filtered.Insert(0, value);
        }

        return Task.FromResult<IEnumerable<string>>(filtered);
    }

    private async Task<IEnumerable<string>> SearchSkills(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            // Show predefined skills by category
            var predefined = _skillService.GetPredefinedSkills();
            return predefined.SelectMany(kvp => kvp.Value).Take(20);
        }

        var skills = await _skillService.SearchSkillsAsync(value);
        var skillNames = skills.Select(s => s.Name).ToList();
        
        // Add typed value as option if not in results
        if (!skillNames.Any(s => s.Equals(value, StringComparison.OrdinalIgnoreCase)))
        {
            skillNames.Insert(0, value);
        }
        
        return skillNames;
    }

    private void OnSkillBlur()
    {
        if (!string.IsNullOrWhiteSpace(selectedSkill))
        {
            AddSkill(selectedSkill);
            selectedSkill = null; // Clear the field after adding
        }
    }

    private void AddSkill(string skill)
    {
        if (string.IsNullOrWhiteSpace(skill)) return;
        if (goodWork.RequiredSkills.Contains(skill, StringComparer.OrdinalIgnoreCase)) return;
        
        goodWork.RequiredSkills.Add(skill);
        StateHasChanged();
    }

    private async Task OnAddressChanged(string address)
    {
        if (string.IsNullOrEmpty(address)) return;

        var (latitude, longitude) = await _geoCodingServices.GetCoordinatesAsync(address);

        goodWork.Address = address;
        goodWork.Latitude = latitude;
        goodWork.Longitude = longitude;

        await UpdateMapLocation(latitude, longitude);
    }

    private async Task InitializeMap()
    {
        try
        {
            if (_map?.InteropObject == null)
            {
                Console.WriteLine("Map not yet initialized, waiting...");
                mapError = true;
                StateHasChanged();
                return;
            }

            mapError = false;

            // Set default center if no location specified
            if (goodWork.Latitude == 0 && goodWork.Longitude == 0)
            {
                goodWork.Latitude = 34.7304;
                goodWork.Longitude = -86.5861;
            }

            await UpdateMapLocation(goodWork.Latitude, goodWork.Longitude);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing map: {ex.Message}");
            mapError = true;
            StateHasChanged();
        }
    }

    private async Task UpdateMapLocation(double latitude, double longitude)
    {
        if (_map?.InteropObject == null)
        {
            Console.WriteLine("Map InteropObject is null, cannot update location");
            return;
        }

        try
        {
            var position = new LatLngLiteral(latitude, longitude);

            await _map.InteropObject.SetCenter(position);
            await _map.InteropObject.SetZoom(12);

            if (_marker != null)
            {
                await _marker.SetMap(null);
            }

            _marker = await Marker.CreateAsync(_map.JsRuntime, new MarkerOptions
            {
                Position = position,
                Map = _map.InteropObject,
                Title = "Selected Location"
            });

            Console.WriteLine($"Map updated to: {latitude}, {longitude}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating map location: {ex.Message}");
        }
    }

    private async Task OnValidSubmit()
    {
        try
        {
            if (goodWork.StartTime.HasValue && _startTime.HasValue)
            {
                goodWork.StartTime = goodWork.StartTime.Value.Date.Add(_startTime.Value);
            }
            else if (_startTime.HasValue)
            {
                goodWork.StartTime = DateTime.Today.Add(_startTime.Value);
            }

            if (goodWork.EndTime.HasValue && _endTime.HasValue)
            {
                goodWork.EndTime = goodWork.EndTime.Value.Date.Add(_endTime.Value);
            }
            else if (_endTime.HasValue)
            {
                goodWork.EndTime = DateTime.Today.Add(_endTime.Value);
            }

            // Build recurrence pattern before saving
            BuildRecurrencePattern();

            // Set organization fields if posting as organization
            if (selectedOrganizationId.HasValue)
            {
                var selectedOrg = userOrganizations?.FirstOrDefault(o => o.Id == selectedOrganizationId);
                if (selectedOrg != null)
                {
                    goodWork.IsOrganizationPost = true;
                    goodWork.OrganizationId = selectedOrg.Id;
                    goodWork.OrganizationSlug = selectedOrg.Slug;
                    goodWork.OrganizationName = selectedOrg.Name;
                }
            }
            else
            {
                goodWork.IsOrganizationPost = false;
                goodWork.OrganizationId = null;
                goodWork.OrganizationSlug = null;
                goodWork.OrganizationName = null;
            }

            goodWork.CreatedBy = userId ?? "";

            await _neo4jService.CreateGoodWorkAsync(goodWork, userId);
            
            // Create POSTED_BY relationship if it's an organization post
            if (goodWork.IsOrganizationPost && goodWork.Id.HasValue && goodWork.OrganizationId.HasValue)
            {
                await CreateGoodWorkOrganizationRelationship(goodWork.Id.Value, goodWork.OrganizationId.Value);
            }
            
            success = true;
            errorMessage = null;

            // Reset form after a short delay
            await Task.Delay(1500);
            goodWork = new GoodWorksModel { CreatedDate = DateTime.UtcNow };
            selectedDays.Clear();
            selectedOrganizationId = null;
            success = false;

            if (_marker != null)
            {
                await _marker.SetMap(null);
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating good work: {ex.Message}";
            success = false;
        }
    }

    private async Task CreateGoodWorkOrganizationRelationship(long goodWorkId, long organizationId)
    {
        Console.WriteLine($"DEBUG: Creating POSTED_BY relationship - GoodWork ID: {goodWorkId}, Organization ID: {organizationId}");
        
        var query = @"
            MATCH (g:GoodWork), (o:Organization)
            WHERE id(g) = $goodWorkId AND id(o) = $organizationId
            MERGE (g)-[:POSTED_BY]->(o)
            RETURN count(*) as count";

        await using var session = _neo4jService.GetSession();
        await session.RunAsync(query, new { goodWorkId, organizationId });
        
        Console.WriteLine($"DEBUG: POSTED_BY relationship created successfully");
    }

    private void RemoveSkill(string skill)
    {
        goodWork.RequiredSkills.Remove(skill);
        StateHasChanged();
    }
}
