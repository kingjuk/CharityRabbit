@page "/search"
@using CharityRabbit.Models
@using CharityRabbit.Data
@using GoogleMapsComponents
@using GoogleMapsComponents.Maps
@using MouseEvent = GoogleMapsComponents.Maps.MouseEvent
@inject Neo4jService _neo4jService
@inject SeoService _seoService
@inject SkillService _skillService
@inject IJSRuntime JSRuntime

<PageTitle>Search Volunteer Opportunities - CharityRabbit</PageTitle>

<HeadContent>
    <meta name="description" content="Search and filter volunteer opportunities by category, location, and availability. Find the perfect way to give back to your community." />
    <meta name="keywords" content="search volunteers, find volunteering, volunteer search, charity search, community service opportunities" />
    <link rel="canonical" href="@_seoService.GetCanonicalUrl("/search")" />
    
    <!-- Open Graph -->
    <meta property="og:title" content="Search Volunteer Opportunities - CharityRabbit" />
    <meta property="og:description" content="Find volunteer opportunities near you" />
    <meta property="og:url" content="@_seoService.GetCanonicalUrl("/search")" />
</HeadContent>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4 mt-4">
    <MudPaper Elevation="4" Class="pa-4">
        <MudText Typo="Typo.h4" GutterBottom="true">Find Good Works</MudText>
        
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
            <!-- Grid View Tab -->
            <MudTabPanel Text="Grid View" Icon="@Icons.Material.Filled.TableChart">
                <MudGrid>
                    <!-- Filters Sidebar -->
                    <MudItem xs="12" md="3">
                        <MudPaper Elevation="2" Class="pa-3">
                            <MudText Typo="Typo.h6" GutterBottom="true">Filters</MudText>
                            
                            <!-- Category -->
                            <MudSelect @bind-Value="searchCriteria.Category" Label="Category" Clearable="true" Class="mb-3">
                                <MudSelectItem Value="@((string?)null)">All Categories</MudSelectItem>
                                @foreach (var category in categories)
                                {
                                    <MudSelectItem Value="@category">@category</MudSelectItem>
                                }
                            </MudSelect>

                            <!-- Skills Filter -->
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Required Skills</MudText>
                            <MudAutocomplete T="string"
                                             Label="Add Skill Filter"
                                             SearchFunc="SearchSkills"
                                             @bind-Value="selectedSkillFilter"
                                             Clearable="true"
                                             Dense="true"
                                             Class="mb-2"
                                             HelperText="Filter by required skills"
                                             CoerceValue="false"
                                             ResetValueOnEmptyText="true"
                                             @onblur="OnSkillFilterBlur" />

                            @if (selectedSkills.Any())
                            {
                                <div class="d-flex flex-wrap gap-1 mb-3">
                                    @foreach (var skill in selectedSkills)
                                    {
                                        <MudChip T="string"
                                               Text="@skill"
                                               Size="MudBlazor.Size.Small"
                                               Color="Color.Primary"
                                               OnClose="@(() => RemoveSkillFilter(skill))">
                                            @skill
                                        </MudChip>
                                    }
                                </div>
                            }

                            <!-- Date Range -->
                            <MudDatePicker @bind-Date="startDateFrom" Label="Start Date From" Class="mb-3" />
                            <MudDatePicker @bind-Date="startDateTo" Label="Start Date To" Class="mb-3" />

                            <!-- Location Search -->
                            <MudTextField @bind-Value="zipCode" Label="Zip Code" Class="mb-3" />
                            <MudNumericField @bind-Value="searchRadius" Label="Search Radius (miles)" Min="1" Max="100" Class="mb-3" />

                            <!-- Checkboxes -->
                            <MudCheckBox @bind-Value="searchCriteria.IsVirtual" Label="Virtual Only" Class="mb-2" />
                            <MudCheckBox @bind-Value="searchCriteria.IsAccessible" Label="Wheelchair Accessible" Class="mb-2" />
                            <MudCheckBox @bind-Value="searchCriteria.FamilyFriendly" Label="Family Friendly" Class="mb-2" />
                            <MudCheckBox @bind-Value="availableSpotsOnly" Label="Available Spots Only" Class="mb-3" />

                            <!-- Action Buttons -->
                            <MudButton Variant="Variant.Filled" 
                                     Color="Color.Primary" 
                                     FullWidth="true"
                                     StartIcon="@Icons.Material.Filled.Search"
                                     OnClick="PerformSearch"
                                     Class="mb-2">
                                Search
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                     Color="Color.Secondary" 
                                     FullWidth="true"
                                     OnClick="ClearFilters">
                                Clear Filters
                            </MudButton>
                        </MudPaper>
                    </MudItem>

                    <!-- Results Grid -->
                    <MudItem xs="12" md="9">
                        @if (isLoading)
                        {
                            <div class="d-flex justify-center align-center" style="min-height: 400px;">
                                <MudProgressCircular Indeterminate="true" Size="MudBlazor.Size.Large" />
                                <MudText Typo="Typo.h6" Class="ml-3">Loading upcoming events...</MudText>
                            </div>
                        }
                        else if (searchResults == null)
                        {
                            <MudPaper Elevation="0" Class="pa-4 text-center">
                                <MudIcon Icon="@Icons.Material.Filled.Search" Size="MudBlazor.Size.Large" Color="Color.Primary" />
                                <MudText Typo="Typo.h6" Class="mt-2">Use filters to search for good works</MudText>
                            </MudPaper>
                        }
                        else if (!searchResults.Any())
                        {
                            <MudPaper Elevation="0" Class="pa-4 text-center">
                                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="MudBlazor.Size.Large" Color="Color.Secondary" />
                                <MudText Typo="Typo.h6" Class="mt-2">No results found</MudText>
                                <MudText Typo="Typo.body2">Try adjusting your search criteria</MudText>
                            </MudPaper>
                        }
                        else
                        {
                            <MudDataGrid @ref="dataGrid" T="GoodWorksModel" Items="@searchResults" 
                                       Filterable="true" Dense="true" Hover="true">
                                <ToolBarContent>
                                    <MudText Typo="Typo.h6">Found @searchResults.Count opportunities</MudText>
                                    <MudSpacer />
                                    <MudTextField T="string" ValueChanged="@OnGridSearch" Placeholder="Search Results"
                                                Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                                                IconSize="MudBlazor.Size.Medium" Immediate="true" />
                                </ToolBarContent>

                                <Columns>
                                    <PropertyColumn Property="x => x.Name" Title="Name">
                                        <CellTemplate>
                                            <MudLink Href="@($"/goodwork/{context.Item.Id}")">@context.Item.Name</MudLink>
                                        </CellTemplate>
                                    </PropertyColumn>
                                    <PropertyColumn Property="x => x.Category" Title="Category" />
                                    <PropertyColumn Property="x => x.StartTime" Title="Date">
                                        <CellTemplate>
                                            @if (context.Item.StartTime.HasValue)
                                            {
                                                @context.Item.StartTime.Value.ToString("MMM dd, yyyy")
                                            }
                                        </CellTemplate>
                                    </PropertyColumn>
                                    <TemplateColumn Title="Details" Sortable="false" Filterable="false" T="GoodWorksModel">
                                        <CellTemplate>
                                            <div class="d-flex flex-wrap gap-1">
                                                @if (context.Item.IsVirtual)
                                                {
                                                    <MudChip T="string" Size="MudBlazor.Size.Small" Color="Color.Info">Virtual</MudChip>
                                                }
                                                @if (context.Item.FamilyFriendly)
                                                {
                                                    <MudChip T="string" Size="MudBlazor.Size.Small" Color="Color.Success">Family</MudChip>
                                                }
                                            </div>
                                        </CellTemplate>
                                    </TemplateColumn>
                                    <TemplateColumn Title="Actions" Sortable="false" Filterable="false" T="GoodWorksModel">
                                        <CellTemplate>
                                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                         Color="Color.Primary" 
                                                         Size="MudBlazor.Size.Small"
                                                         Href="@($"/goodwork/{context.Item.Id}")" />
                                        </CellTemplate>
                                    </TemplateColumn>
                                </Columns>

                                <PagerContent>
                                    <MudDataGridPager T="GoodWorksModel" />
                                </PagerContent>
                            </MudDataGrid>
                        }
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            <!-- Map View Tab -->
            <MudTabPanel Text="Map View" Icon="@Icons.Material.Filled.Map">
                <MudGrid>
                    <!-- Map Filters (same as grid) -->
                    <MudItem xs="12" md="3">
                        <MudPaper Elevation="2" Class="pa-3">
                            <MudText Typo="Typo.h6" GutterBottom="true">Filters</MudText>
                            
                            <MudSelect @bind-Value="searchCriteria.Category" Label="Category" Clearable="true" Class="mb-3">
                                <MudSelectItem Value="@((string?)null)">All Categories</MudSelectItem>
                                @foreach (var category in categories)
                                {
                                    <MudSelectItem Value="@category">@category</MudSelectItem>
                                }
                            </MudSelect>

                            <MudDatePicker @bind-Date="startDateFrom" Label="Start Date From" Class="mb-3" />
                            <MudDatePicker @bind-Date="startDateTo" Label="Start Date To" Class="mb-3" />

                            <MudCheckBox @bind-Value="searchCriteria.IsVirtual" Label="Virtual Only" Class="mb-2" />
                            <MudCheckBox @bind-Value="searchCriteria.IsAccessible" Label="Wheelchair Accessible" Class="mb-2" />
                            <MudCheckBox @bind-Value="searchCriteria.FamilyFriendly" Label="Family Friendly" Class="mb-2" />
                            <MudCheckBox @bind-Value="availableSpotsOnly" Label="Available Spots Only" Class="mb-3" />

                            <MudButton Variant="Variant.Filled" 
                                     Color="Color.Primary" 
                                     FullWidth="true"
                                     StartIcon="@Icons.Material.Filled.Search"
                                     OnClick="PerformSearch"
                                     Class="mb-2">
                                Search
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                     Color="Color.Secondary" 
                                     FullWidth="true"
                                     OnClick="ClearFilters">
                                Clear Filters
                            </MudButton>

                            @if (searchResults != null)
                            {
                                <MudDivider Class="my-3" />
                                <MudText Typo="Typo.body2" Color="Color.Info">
                                    <MudIcon Icon="@Icons.Material.Filled.Place" Size="MudBlazor.Size.Small" /> 
                                    @searchResults.Count markers on map
                                </MudText>
                                
                                <MudDivider Class="my-3" />
                                <MudText Typo="Typo.subtitle2" GutterBottom="true">Legend</MudText>
                                <div style="display: flex; flex-direction: column; gap: 6px;">
                                    @foreach (var category in categories)
                                    {
                                        var letter = category.Substring(0, 1).ToUpper();
                                        var color = categoryColors[category];
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 24px; height: 24px; background-color: @color; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                                @letter
                                            </div>
                                            <MudText Typo="Typo.body2">@category</MudText>
                                        </div>
                                    }
                                </div>
                            }
                        </MudPaper>
                    </MudItem>

                    <!-- Map Display -->
                    <MudItem xs="12" md="9">
                        <MudPaper Elevation="2" Class="pa-2" Style="height: 700px;">
                            @if (isLoading)
                            {
                                <div class="d-flex justify-center align-center" style="height: 100%;">
                                    <MudProgressCircular Indeterminate="true" Size="MudBlazor.Size.Large" />
                                </div>
                            }
                            else
                            {
                                <GoogleMap @ref="_map" Id="map1" Options="@_mapOptions" Height="100%" OnAfterInit="OnMapInitialized"></GoogleMap>
                            }
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            <!-- Calendar View Tab -->
            <MudTabPanel Text="Calendar View" Icon="@Icons.Material.Filled.CalendarMonth">
                <MudGrid>
                    <!-- Calendar Filters -->
                    <MudItem xs="12" md="3">
                        <MudPaper Elevation="2" Class="pa-3">
                            <MudText Typo="Typo.h6" GutterBottom="true">Filters</MudText>
                            
                            <MudSelect @bind-Value="searchCriteria.Category" Label="Category" Clearable="true" Class="mb-3">
                                <MudSelectItem Value="@((string?)null)">All Categories</MudSelectItem>
                                @foreach (var category in categories)
                                {
                                    <MudSelectItem Value="@category">@category</MudSelectItem>
                                }
                            </MudSelect>

                            <MudCheckBox @bind-Value="searchCriteria.IsVirtual" Label="Virtual Only" Class="mb-2" />
                            <MudCheckBox @bind-Value="searchCriteria.IsAccessible" Label="Wheelchair Accessible" Class="mb-2" />
                            <MudCheckBox @bind-Value="searchCriteria.FamilyFriendly" Label="Family Friendly" Class="mb-2" />
                            <MudCheckBox @bind-Value="availableSpotsOnly" Label="Available Spots Only" Class="mb-3" />

                            <MudButton Variant="Variant.Filled" 
                                     Color="Color.Primary" 
                                     FullWidth="true"
                                     StartIcon="@Icons.Material.Filled.Search"
                                     OnClick="PerformSearch"
                                     Class="mb-2">
                                Search
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                     Color="Color.Secondary" 
                                     FullWidth="true"
                                     OnClick="ClearFilters">
                                Clear Filters
                            </MudButton>

                            @if (searchResults != null && calendarEvents.Any())
                            {
                                <MudDivider Class="my-3" />
                                <MudText Typo="Typo.body2" Color="Color.Info">
                                    <MudIcon Icon="@Icons.Material.Filled.Event" Size="MudBlazor.Size.Small" /> 
                                    @calendarEvents.Count events this month
                                </MudText>
                                
                                <MudDivider Class="my-3" />
                                <MudText Typo="Typo.subtitle2" GutterBottom="true">Legend</MudText>
                                <div style="display: flex; flex-direction: column; gap: 6px;">
                                    @foreach (var category in categories)
                                    {
                                        var color = categoryColors[category];
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="width: 20px; height: 20px; background-color: @color; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1);"></div>
                                            <MudText Typo="Typo.body2">@category</MudText>
                                        </div>
                                    }
                                </div>
                            }
                        </MudPaper>
                    </MudItem>

                    <!-- Calendar Display -->
                    <MudItem xs="12" md="9">
                        @if (isLoading)
                        {
                            <div class="d-flex justify-center align-center" style="min-height: 600px;">
                                <MudProgressCircular Indeterminate="true" Size="MudBlazor.Size.Large" />
                                <MudText Typo="Typo.h6" Class="ml-3">Loading calendar...</MudText>
                            </div>
                        }
                        else
                        {
                            <MudPaper Elevation="2" Class="pa-3">
                                <!-- Calendar Header -->
                                <div class="d-flex justify-space-between align-center mb-3">
                                    <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" 
                                                 OnClick="@(() => ChangeMonth(-1))" 
                                                 Color="Color.Primary" />
                                    <MudText Typo="Typo.h5">@currentCalendarMonth.ToString("MMMM yyyy")</MudText>
                                    <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" 
                                                 OnClick="@(() => ChangeMonth(1))" 
                                                 Color="Color.Primary" />
                                </div>

                                <!-- Calendar Grid -->
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                                    <!-- Day Headers -->
                                    @foreach (var day in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
                                    {
                                        <div style="text-align: center; padding: 8px; font-weight: bold; background-color: #f5f5f5; border-radius: 4px;">
                                            @day
                                        </div>
                                    }

                                    <!-- Calendar Days -->
                                    @foreach (var day in GetCalendarDays())
                                    {
                                        var dayEvents = GetEventsForDay(day);
                                        var isCurrentMonth = day.Month == currentCalendarMonth.Month;
                                        var isToday = day.Date == DateTime.Today;
                                        
                                        <div style="@GetDayStyle(isCurrentMonth, isToday)" @onclick="@(() => SelectDay(day))">
                                            <div style="font-weight: @(isToday ? "bold" : "normal"); color: @(isCurrentMonth ? "#424242" : "#9E9E9E"); margin-bottom: 4px;">
                                                @day.Day
                                            </div>
                                            @if (dayEvents.Any())
                                            {
                                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                                    @foreach (var evt in dayEvents.Take(3))
                                                    {
                                                        var color = categoryColors.ContainsKey(evt.Category ?? "") ? categoryColors[evt.Category ?? ""] : "#1976d2";
                                                        <div style="@GetEventBadgeStyle(color)" 
                                                             title="@evt.Name">
                                                            <span style="font-size: 10px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                                @evt.StartTime?.ToString("h:mm tt") - @(evt.Name.Length > 15 ? evt.Name.Substring(0, 15) + "..." : evt.Name)
                                                            </span>
                                                        </div>
                                                    }
                                                    @if (dayEvents.Count > 3)
                                                    {
                                                        <div style="font-size: 10px; color: #666; text-align: center; padding: 2px;">
                                                            +@(dayEvents.Count - 3) more
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>

                                <!-- Selected Day Events -->
                                @if (selectedDate.HasValue)
                                {
                                    var selectedDayEvents = GetEventsForDay(selectedDate.Value);
                                    <MudDivider Class="my-4" />
                                    <MudText Typo="Typo.h6" GutterBottom="true">
                                        Events on @selectedDate.Value.ToString("MMMM dd, yyyy")
                                    </MudText>
                                    
                                    @if (selectedDayEvents.Any())
                                    {
                                        <MudList T="GoodWorksModel" Dense="true">
                                            @foreach (var evt in selectedDayEvents.OrderBy(e => e.StartTime))
                                            {
                                                var color = categoryColors.ContainsKey(evt.Category ?? "") ? categoryColors[evt.Category ?? ""] : "#1976d2";
                                                <MudListItem>
                                                    <div class="d-flex align-center gap-2">
                                                        <div style="width: 4px; height: 40px; background-color: @color; border-radius: 2px;"></div>
                                                        <div style="flex: 1;">
                                                            <MudLink Href="@($"/goodwork/{evt.Id}")" Typo="Typo.body1">
                                                                <strong>@evt.Name</strong>
                                                            </MudLink>
                                                            <div class="d-flex gap-2 align-center mt-1">
                                                                <MudChip T="string" Size="MudBlazor.Size.Small" Style="@($"background-color: {color}; color: white;")">
                                                                    @evt.Category
                                                                </MudChip>
                                                                <MudText Typo="Typo.caption">
                                                                    @evt.StartTime?.ToString("h:mm tt") - @evt.EndTime?.ToString("h:mm tt")
                                                                </MudText>
                                                            </div>
                                                            @if (!string.IsNullOrEmpty(evt.Address))
                                                            {
                                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="MudBlazor.Size.Small" /> @evt.Address
                                                                </MudText>
                                                            }
                                                        </div>
                                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                                     Color="Color.Primary" 
                                                                     Size="MudBlazor.Size.Small"
                                                                     Href="@($"/goodwork/{evt.Id}")" />
                                                    </div>
                                                </MudListItem>
                                                <MudDivider />
                                            }
                                        </MudList>
                                    }
                                    else
                                    {
                                        <MudAlert Severity="Severity.Info">No events scheduled for this day</MudAlert>
                                    }
                                }
                            </MudPaper>
                        }
                    </MudItem>
                </MudGrid>
            </MudTabPanel>
        </MudTabs>
    </MudPaper>
</MudContainer>

@code {
    private GoodWorksSearchCriteria searchCriteria = new();
    private List<GoodWorksModel>? searchResults;
    private List<GoodWorksModel> filteredResults = new();
    private bool isLoading = false;
    private MudDataGrid<GoodWorksModel>? dataGrid;
    
    private DateTime? startDateFrom;
    private DateTime? startDateTo;
    private string? zipCode;
    private double searchRadius = 25;
    private bool availableSpotsOnly = false;
    private List<string> selectedSkills = new();
    private string? selectedSkillFilter;

    // Map fields
    private GoogleMap? _map;
    private MapOptions _mapOptions = new();
    private List<Marker> _markers = new();

    // Calendar fields
    private DateTime currentCalendarMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
    private DateTime? selectedDate;
    private List<GoodWorksModel> calendarEvents = new();

    private readonly List<string> categories = new()
    {
        "Food Bank",
        "Homeless Shelter",
        "Environmental",
        "Education",
        "Healthcare",
        "Animal Welfare",
        "Community Service",
        "Youth Programs",
        "Senior Care",
        "Disaster Relief"
    };

    // Category icon mapping
    private readonly Dictionary<string, string> categoryIcons = new()
    {
        { "Food Bank", "???" },
        { "Homeless Shelter", "??" },
        { "Environmental", "??" },
        { "Education", "??" },
        { "Healthcare", "??" },
        { "Animal Welfare", "??" },
        { "Community Service", "??" },
        { "Youth Programs", "??" },
        { "Senior Care", "??" },
        { "Disaster Relief", "??" }
    };

    // Category color mapping for markers
    private readonly Dictionary<string, string> categoryColors = new()
    {
        { "Food Bank", "#FF6B6B" },           // Red
        { "Homeless Shelter", "#4ECDC4" },    // Teal
        { "Environmental", "#45B7D1" },       // Green-blue
        { "Education", "#FFA07A" },           // Light coral
        { "Healthcare", "#98D8C8" },          // Mint
        { "Animal Welfare", "#F7DC6F" },      // Yellow
        { "Community Service", "#BB8FCE" },   // Purple
        { "Youth Programs", "#85C1E2" },      // Sky blue
        { "Senior Care", "#F8B739" },         // Orange
        { "Disaster Relief", "#EC7063" }      // Dark red
    };

    protected override async Task OnInitializedAsync()
    {
        // Try to get user's location, fall back to Huntsville, AL
        var userLocation = await TryGetUserLocation();
        
        _mapOptions = new MapOptions
        {
            Zoom = 11,
            Center = userLocation,
            MapTypeId = MapTypeId.Roadmap
        };

        // Auto-load upcoming events on page load
        await LoadUpcomingEvents();
    }

    private async Task<LatLngLiteral> TryGetUserLocation()
    {
        // Default location (Huntsville, AL)
        var defaultLocation = new LatLngLiteral(34.7304, -86.5861);
        
        try
        {
            // Try to get user's current location from browser
            var result = await JSRuntime.InvokeAsync<GeolocationResult?>("geolocationHelper.getCurrentPosition");
            
            if (result != null && result.Latitude != 0 && result.Longitude != 0)
            {
                Console.WriteLine($"User location detected: {result.Latitude}, {result.Longitude}");
                return new LatLngLiteral(result.Latitude, result.Longitude);
            }
            
            Console.WriteLine("Using default location (Huntsville, AL)");
            return defaultLocation;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Geolocation error: {ex.Message}. Using default location.");
            return defaultLocation;
        }
    }

    // Helper class for geolocation result
    private class GeolocationResult
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public double Accuracy { get; set; }
    }

    private async Task LoadUpcomingEvents()
    {
        isLoading = true;

        // Set date range to next 3 months
        startDateFrom = DateTime.Today.Subtract(TimeSpan.FromDays(10));
        startDateTo = DateTime.Today.AddMonths(3);

        searchCriteria.StartDateFrom = startDateFrom;
        searchCriteria.StartDateTo = startDateTo;

        try
        {
            searchResults = await _neo4jService.SearchGoodWorksAsync(searchCriteria);
            
            // Take only first 100 results
            if (searchResults.Count > 100)
            {
                searchResults = searchResults.Take(100).ToList();
            }
            
            filteredResults = searchResults;
            
            // Initialize calendar events
            UpdateCalendarEvents();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading upcoming events: {ex.Message}");
            searchResults = new List<GoodWorksModel>();
        }

        isLoading = false;
    }

    private async Task PerformSearch()
    {
        isLoading = true;
        
        searchCriteria.StartDateFrom = startDateFrom;
        searchCriteria.StartDateTo = startDateTo;
        searchCriteria.HasAvailableSpots = availableSpotsOnly;

        searchResults = await _neo4jService.SearchGoodWorksAsync(searchCriteria);
        filteredResults = searchResults;
        
        // Update calendar events
        UpdateCalendarEvents();
        
        // Update map markers
        await UpdateMapMarkers();
        
        isLoading = false;
    }

    private void UpdateCalendarEvents()
    {
        if (searchResults == null)
        {
            calendarEvents = new();
            return;
        }

        // Filter events for the current calendar month
        var monthStart = new DateTime(currentCalendarMonth.Year, currentCalendarMonth.Month, 1);
        var monthEnd = monthStart.AddMonths(1).AddDays(-1);

        calendarEvents = searchResults
            .Where(e => e.StartTime.HasValue && 
                       e.StartTime.Value.Date >= monthStart && 
                       e.StartTime.Value.Date <= monthEnd)
            .ToList();
    }

    private void ChangeMonth(int months)
    {
        currentCalendarMonth = currentCalendarMonth.AddMonths(months);
        UpdateCalendarEvents();
        selectedDate = null; // Clear selection when changing months
    }

    private List<DateTime> GetCalendarDays()
    {
        var days = new List<DateTime>();
        var firstDay = new DateTime(currentCalendarMonth.Year, currentCalendarMonth.Month, 1);
        var lastDay = firstDay.AddMonths(1).AddDays(-1);

        // Get the first Sunday before or on the first day of the month
        var startDate = firstDay.AddDays(-(int)firstDay.DayOfWeek);

        // Get the last Saturday after or on the last day of the month
        var endDate = lastDay.AddDays(6 - (int)lastDay.DayOfWeek);

        for (var date = startDate; date <= endDate; date = date.AddDays(1))
        {
            days.Add(date);
        }

        return days;
    }

    private List<GoodWorksModel> GetEventsForDay(DateTime day)
    {
        if (searchResults == null) return new List<GoodWorksModel>();

        return searchResults
            .Where(e => e.StartTime.HasValue && e.StartTime.Value.Date == day.Date)
            .OrderBy(e => e.StartTime)
            .ToList();
    }

    private void SelectDay(DateTime day)
    {
        selectedDate = day;
    }

    private string GetDayStyle(bool isCurrentMonth, bool isToday)
    {
        var bgColor = isToday ? "#E3F2FD" : "white";
        var borderColor = isToday ? "#1976D2" : "#E0E0E0";
        var opacity = isCurrentMonth ? "1" : "0.5";
        
        return $"min-height: 100px; padding: 8px; border: 2px solid {borderColor}; border-radius: 4px; background-color: {bgColor}; opacity: {opacity}; cursor: pointer; transition: all 0.2s;";
    }

    private string GetEventBadgeStyle(string color)
    {
        return $"background-color: {color}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; cursor: pointer; transition: opacity 0.2s;";
    }

    private void OnGridSearch(string searchText)
    {
        if (searchResults == null) return;

        if (string.IsNullOrWhiteSpace(searchText))
        {
            filteredResults = searchResults;
        }
        else
        {
            filteredResults = searchResults.Where(g =>
                (g.Name?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (g.Category?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (g.Description?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (g.ContactName?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            ).ToList();
        }

        searchResults = filteredResults;
        StateHasChanged();
    }

    private void ClearFilters()
    {
        searchCriteria = new GoodWorksSearchCriteria();
        startDateFrom = null;
        startDateTo = null;
        zipCode = null;
        searchRadius = 25;
        availableSpotsOnly = false;
        selectedSkills.Clear();
        searchResults = null;
        filteredResults = new();
        
        // Clear map markers
        ClearMarkers();
        
        // Reset calendar
        currentCalendarMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
        selectedDate = null;
        calendarEvents = new();
    }

    private async Task<IEnumerable<string>> SearchSkills(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            var all = await _skillService.GetAllSkillsAsync();
            return all.Select(s => s.Name).Take(20);
        }
        var skills = await _skillService.SearchSkillsAsync(value);
        return skills.Select(s => s.Name);
    }

    private void OnSkillFilterBlur()
    {
        if (!string.IsNullOrWhiteSpace(selectedSkillFilter))
        {
            AddSkillFilter(selectedSkillFilter);
            selectedSkillFilter = null;
        }
    }

    private void AddSkillFilter(string skill)
    {
        if (string.IsNullOrWhiteSpace(skill)) return;
        if (!selectedSkills.Contains(skill, StringComparer.OrdinalIgnoreCase))
        {
            selectedSkills.Add(skill);
            searchCriteria.RequiredSkills = selectedSkills;
        }
    }

    private void RemoveSkillFilter(string skill)
    {
        selectedSkills.Remove(skill);
        searchCriteria.RequiredSkills = selectedSkills.Any() ? selectedSkills : null;
    }

    private async Task OnMapInitialized()
    {
        if (searchResults != null)
        {
            await UpdateMapMarkers();
        }
    }

    private async Task UpdateMapMarkers()
    {
        if (_map == null || _map.InteropObject == null || searchResults == null) 
        {
            return;
        }

        ClearMarkers();

        foreach (var goodWork in searchResults)
        {
            if (goodWork.Latitude == 0 && goodWork.Longitude == 0) continue;

            try
            {
                var color = categoryColors.ContainsKey(goodWork.Category ?? "") 
                    ? categoryColors[goodWork.Category ?? ""] 
                    : "#1976d2";

                var categoryLetter = !string.IsNullOrEmpty(goodWork.Category) ? goodWork.Category.Substring(0, 1).ToUpper() : "?";                

                var svgMarker = $@"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='38' height='50' viewBox='0 0 38 50'%3E%3Cpath fill='{Uri.EscapeDataString(color)}' stroke='%23FFFFFF' stroke-width='2' d='M19 0C8.5 0 0 8.5 0 19c0 14 19 31 19 31s19-17 19-31c0-10.5-8.5-19-19-19z'/%3E%3Ccircle cx='19' cy='19' r='12' fill='white' opacity='0.9'/%3E%3Ctext x='19' y='25' text-anchor='middle' font-size='18' font-weight='bold' fill='{Uri.EscapeDataString(color)}' font-family='Arial, sans-serif'%3E{categoryLetter}%3C/text%3E%3C/svg%3E";

                var marker = await Marker.CreateAsync(_map.JsRuntime, new MarkerOptions
                {
                    Position = new LatLngLiteral(goodWork.Latitude, goodWork.Longitude),
                    Map = _map.InteropObject,
                    Title = goodWork.Name,
                    Icon = new Icon
                    {
                        Url = svgMarker,
                        ScaledSize = new GoogleMapsComponents.Maps.Size { Height = 50, Width = 38 },
                        Anchor = new Point { X = 19, Y = 50 }
                    },
                    Clickable = true
                });

                var goodWorkForClosure = goodWork;
                await marker.AddListener<MouseEvent>("click", async (e) =>
                {
                    var startTime = goodWorkForClosure.StartTime?.ToString("MMM dd, yyyy h:mm tt") ?? "Not specified";
                    var endTime = goodWorkForClosure.EndTime?.ToString("MMM dd, yyyy h:mm tt") ?? "Not specified";
                    var address = !string.IsNullOrEmpty(goodWorkForClosure.Address) ? goodWorkForClosure.Address : "Address not provided";
                    var detailedDesc = !string.IsNullOrEmpty(goodWorkForClosure.DetailedDescription) ? goodWorkForClosure.DetailedDescription : goodWorkForClosure.Description ?? "No description available";
                    var contactPhone = !string.IsNullOrEmpty(goodWorkForClosure.ContactPhone) ? $"<div style='font-size: 13px; color: #2E7D32;'>Phone: {goodWorkForClosure.ContactPhone}</div>" : "";
                    var contactEmail = !string.IsNullOrEmpty(goodWorkForClosure.ContactEmail) ? goodWorkForClosure.ContactEmail : "Not provided";
                    var contactName = !string.IsNullOrEmpty(goodWorkForClosure.ContactName) ? goodWorkForClosure.ContactName : "Not provided";

                    var infoWindow = await InfoWindow.CreateAsync(_map.JsRuntime, new InfoWindowOptions
                    {
                        Content = $@"
                            <div style='max-width: 350px; padding: 12px; font-family: Roboto, Arial, sans-serif;'>
                                <h3 style='margin: 0 0 8px 0; color: #1976D2; font-size: 18px; font-weight: 500;'>{goodWorkForClosure.Name}</h3>
                                
                                <div style='margin-bottom: 12px;'>
                                    <span style='background: #E3F2FD; color: #1976D2; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;'>
                                        {goodWorkForClosure.Category}
                                    </span>
                                </div>

                                <p style='margin: 8px 0; color: #424242; font-size: 14px; line-height: 1.5;'>{detailedDesc}</p>
                                
                                <div style='margin: 12px 0; padding: 8px; background: #F5F5F5; border-radius: 4px;'>
                                    <div style='margin-bottom: 4px; font-size: 13px; color: #616161;'>
                                        <strong>Start:</strong> {startTime}
                                    </div>
                                    <div style='margin-bottom: 4px; font-size: 13px; color: #616161;'>
                                        <strong>End:</strong> {endTime}
                                    </div>
                                    <div style='font-size: 13px; color: #616161;'>
                                        <strong>Location:</strong> {address}
                                    </div>
                                </div>

                                <div style='margin: 12px 0; padding: 8px; background: #E8F5E9; border-radius: 4px;'>
                                    <div style='font-size: 13px; color: #2E7D32; margin-bottom: 4px;'>
                                        <strong>Contact:</strong> {contactName}
                                    </div>
                                    <div style='font-size: 13px; color: #2E7D32;'>
                                        Email: {contactEmail}
                                    </div>
                                    {contactPhone}
                                </div>

                                {(goodWorkForClosure.MaxParticipants.HasValue ? $@"
                                <div style='margin: 8px 0; font-size: 13px; color: #616161;'>
                                    <strong>Participants:</strong> {goodWorkForClosure.CurrentParticipants} / {goodWorkForClosure.MaxParticipants.Value}
                                </div>" : "")}

                                {(goodWorkForClosure.IsAccessible ? "<div style='margin: 4px 0; font-size: 12px; color: #4CAF50;'>Wheelchair Accessible</div>" : "")}
                                {(goodWorkForClosure.IsVirtual ? "<div style='margin: 4px 0; font-size: 12px; color: #2196F3;'>Virtual Event</div>" : "")}
                                {(goodWorkForClosure.FamilyFriendly ? "<div style='margin: 4px 0; font-size: 12px; color: #9C27B0;'>Family Friendly</div>" : "")}

                                <div style='margin-top: 12px; text-align: center;'>
                                    <a href='/goodwork/{goodWorkForClosure.Id}' 
                                       style='display: inline-block; background: #1976D2; color: white; padding: 8px 16px; 
                                              border-radius: 4px; text-decoration: none; font-weight: 500; font-size: 14px;'>
                                        View Full Details
                                    </a>
                                </div>
                            </div>",
                        Position = new LatLngLiteral(goodWorkForClosure.Latitude, goodWorkForClosure.Longitude)
                    });

                    await infoWindow.Open(_map.InteropObject);
                });

                _markers.Add(marker);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error creating marker for {goodWork.Name}: {ex.Message}");
            }
        }

        if (searchResults.Any())
        {
            try
            {
                var avgLat = searchResults.Average(g => g.Latitude);
                var avgLng = searchResults.Average(g => g.Longitude);
                await _map.InteropObject.SetCenter(new LatLngLiteral(avgLat, avgLng));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error centering map: {ex.Message}");
            }
        }
    }

    private void ClearMarkers()
    {
        if (_markers == null || !_markers.Any()) return;

        foreach (var marker in _markers)
        {
            try
            {
                marker?.SetMap(null);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error clearing marker: {ex.Message}");
            }
        }
        _markers.Clear();
    }
}
